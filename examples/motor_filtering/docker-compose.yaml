# PyEdgeTwin Motor Filtering Demo Stack
#
# This Docker Compose file sets up a complete demo environment:
# - Mosquitto MQTT broker
# - InfluxDB 2.x time-series database
# - PyEdgeTwin runtime with Kalman filter
# - Virtual motor asset simulator
# - Streamlit dashboard
#
# Usage:
#   cp .env.example .env
#   docker compose up -d
#   open http://localhost:8501
#
# Note: Uses proper healthchecks and depends_on conditions for reliable startup

version: "3.8"

services:
  # MQTT Broker
  # Note: Mosquitto 2.x requires explicit listener config to avoid local-only mode
  mosquitto:
    image: eclipse-mosquitto:2.0.18
    container_name: pyedgetwin-mosquitto
    ports:
      - "1883:1883"
    volumes:
      - ./mosquitto/config:/mosquitto/config:ro
      - mosquitto_data:/mosquitto/data
      - mosquitto_log:/mosquitto/log
    healthcheck:
      test: ["CMD", "mosquitto_sub", "-p", "1883", "-t", "$$SYS/#", "-C", "1", "-i", "healthcheck", "-W", "3"]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  # Time-series Database
  influxdb:
    image: influxdb:2.7.4
    container_name: pyedgetwin-influxdb
    ports:
      - "8086:8086"
    environment:
      DOCKER_INFLUXDB_INIT_MODE: setup
      DOCKER_INFLUXDB_INIT_USERNAME: ${INFLUXDB_USERNAME:-admin}
      DOCKER_INFLUXDB_INIT_PASSWORD: ${INFLUXDB_PASSWORD:-adminpassword}
      DOCKER_INFLUXDB_INIT_ORG: ${INFLUXDB_ORG:-pyedgetwin}
      DOCKER_INFLUXDB_INIT_BUCKET: ${INFLUXDB_BUCKET:-twins}
      DOCKER_INFLUXDB_INIT_ADMIN_TOKEN: ${INFLUXDB_TOKEN:-dev-token-pyedgetwin-12345}
    volumes:
      - influxdb_data:/var/lib/influxdb2
      - influxdb_config:/etc/influxdb2
    healthcheck:
      test: ["CMD", "influx", "ping"]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  # PyEdgeTwin Runtime
  twin-runtime:
    build:
      context: ../..
      dockerfile: Dockerfile
    container_name: pyedgetwin-runtime
    volumes:
      - ./config:/config:ro
      - ./model_blocks:/app/model_blocks:ro
    environment:
      PYEDGETWIN_MQTT_HOST: mosquitto
      PYEDGETWIN_MQTT_PORT: "1883"
      PYEDGETWIN_INFLUXDB_URL: http://influxdb:8086
      PYEDGETWIN_INFLUXDB_TOKEN: ${INFLUXDB_TOKEN:-dev-token-pyedgetwin-12345}
      PYEDGETWIN_INFLUXDB_ORG: ${INFLUXDB_ORG:-pyedgetwin}
      PYEDGETWIN_INFLUXDB_BUCKET: ${INFLUXDB_BUCKET:-twins}
      # Add model_blocks to Python path
      PYTHONPATH: /app/model_blocks
    depends_on:
      mosquitto:
        condition: service_healthy
      influxdb:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    restart: unless-stopped

  # Virtual Motor Asset Simulator
  virtual-asset:
    build:
      context: ./services/virtual_asset
      dockerfile: Dockerfile
    container_name: pyedgetwin-virtual-asset
    environment:
      MQTT_HOST: mosquitto
      MQTT_PORT: "1883"
      ASSET_ID: motor-001
      PUBLISH_INTERVAL: "1.0"
      SEED: "42"
    depends_on:
      mosquitto:
        condition: service_healthy
    restart: unless-stopped

  # Streamlit Dashboard
  dashboard:
    build:
      context: ./services/dashboard
      dockerfile: Dockerfile
    container_name: pyedgetwin-dashboard
    ports:
      - "8501:8501"
    environment:
      INFLUXDB_URL: http://influxdb:8086
      INFLUXDB_TOKEN: ${INFLUXDB_TOKEN:-dev-token-pyedgetwin-12345}
      INFLUXDB_ORG: ${INFLUXDB_ORG:-pyedgetwin}
      INFLUXDB_BUCKET: ${INFLUXDB_BUCKET:-twins}
    depends_on:
      influxdb:
        condition: service_healthy
    restart: unless-stopped

volumes:
  mosquitto_data:
  mosquitto_log:
  influxdb_data:
  influxdb_config:
